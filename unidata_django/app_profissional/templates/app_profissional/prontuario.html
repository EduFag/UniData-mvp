{% extends 'base_dashboard.html' %}

{% block title %}Prontu√°rio - {{ paciente.user.get_full_name }}{% endblock %}

{% block content %}

    <div style="margin-bottom: 20px;">
        <a href="{% url 'dashboard_profissional' %}" style="color: #64748b; text-decoration: none;">&larr; Voltar para Dashboard</a>
    </div>

    <div class="header">
        <h1>{{ paciente.user.get_full_name }}</h1>
        
        {% if autorizado %}
            <span class="btn" style="background: #dcfce7; color: #166534; cursor: default;">
                üîí Acesso Autorizado Blockchain
            </span>
        {% else %}
            <span class="btn" style="background: #fee2e2; color: #991b1b; cursor: default;">
                ‚õî Sem Permiss√£o
            </span>
        {% endif %}
    </div>

    <div class="card">
        <div style="display: flex; gap: 40px;">
            <div><strong>CPF:</strong> {{ paciente.cpf }}</div>
            <div><strong>Carteira:</strong> <small style="font-family: monospace; background: #f1f5f9; padding: 4px;">{{ paciente.endereco_eth }}</small></div>
        </div>
    </div>

    {% if not autorizado %}
        <div class="alert alert-error">
            <h3>Acesso Negado na Blockchain</h3>
            <p>Voc√™ n√£o possui consentimento registrado no Smart Contract para visualizar ou editar os dados deste paciente.</p>
            <p>Pe√ßa ao paciente para autorizar o endere√ßo m√©dico: <strong>{{ medico.endereco_eth }}</strong></p>
        </div>
    {% else %}

        <div style="display: flex; gap: 20px;">
            
            <div style="flex: 1;">
                <h3 style="margin-top: 0;">Hist√≥rico Cl√≠nico (Blockchain)</h3>
                
                {% for registro in historico %}
                    <div class="card" style="border-left: 4px solid #3b82f6;">
    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 8px;">
        <div>
            <span style="font-weight: bold; color: #1e293b;">Registro #{{ registro.id }}</span>
            <br>
            <small style="color: #64748b; font-size: 0.85em;">
                Dr(a): <span style="font-family: monospace; background: #f1f5f9; padding: 2px 4px; border-radius: 4px;">{{ registro.profissional }}</span>
            </small>
        </div>
        
        <div style="text-align: right;">
            <small style="color: #64748b; font-weight: bold;">üìÖ {{ registro.data_registro }}</small>
        </div>
    </div>

    <p style="margin: 0; font-size: 0.9em; color: #475569; font-weight: 600;">Descri√ß√£o / CID:</p>
    <p style="background: #f8fafc; padding: 12px; border-radius: 6px; margin-top: 5px; border: 1px solid #e2e8f0; color: #334155;">
        {{ registro.cid }}
    </p>

    <div style="margin-top: 10px; text-align: right;">
        <button onclick="editarRegistro('{{ registro.id }}', '{{ registro.cid|escapejs }}')" class="btn btn-blue" style="padding: 6px 12px; font-size: 13px;">
            Editar este registro
        </button>
    </div>
</div>
                {% empty %}
                    <div class="card" style="text-align: center; color: #94a3b8;">
                        Nenhum registro encontrado na blockchain.
                    </div>
                {% endfor %}
            </div>

            <div style="flex: 1;">
                <div class="card" style="position: sticky; top: 20px;">
                    <h3 id="form-title" style="margin-top: 0;">Novo Registro</h3>
                    
                    <form method="POST">
                        {% csrf_token %}
                        <input type="hidden" name="id_prontuario" id="field-id">
                        
                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">Descri√ß√£o / CID / Hash IPFS</label>
                        <textarea name="cid" id="field-cid" rows="6" placeholder="Escreva o diagn√≥stico ou insira o hash do documento..." required></textarea>
                        
                        <div style="margin-top: 15px; display: flex; gap: 10px;">
                            <button type="submit" class="btn btn-green" style="flex: 1;">Salvar na Blockchain</button>
                            <button type="button" onclick="resetarForm()" class="btn btn-red" id="btn-cancelar" style="display: none;">Cancelar</button>
                        </div>
                    </form>
                </div>
            </div>

        </div>

        <script>
            function editarRegistro(id, texto) {
                document.getElementById('form-title').innerText = "Editando Registro #" + id;
                document.getElementById('field-id').value = id;
                document.getElementById('field-cid').value = texto;
                document.getElementById('btn-cancelar').style.display = 'inline-block';
                document.getElementById('field-cid').focus();
            }

            function resetarForm() {
                document.getElementById('form-title').innerText = "Novo Registro";
                document.getElementById('field-id').value = "";
                document.getElementById('field-cid').value = "";
                document.getElementById('btn-cancelar').style.display = 'none';
            }
        </script>

    {% endif %}

{% endblock %}